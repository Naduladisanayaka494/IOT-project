<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Dashboard - Step Count & Fall Detection</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        .status {
            font-size: 1.2em;
            padding: 10px;
            border-radius: 10px;
            margin: 10px;
        }
        #stepCount {
            font-size: 2em;
            color: #4CAF50;
        }
        #fallDetected {
            font-size: 2em;
            color: #f44336;
        }
        #fallDetected.no {
            color: #4CAF50;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.3/mqttws31.min.js"></script>
</head>
<body>

    <h1>IoT Dashboard</h1>
    <div id="statusMessage" class="status">Connecting to MQTT Broker...</div>

    <div>
        <p>Step Count:</p>
        <div id="stepCount">0</div>
    </div>

    <div>
        <p>Fall Detected:</p>
        <div id="fallDetected" class="no">No</div>
    </div>

    <script>
        const mqttServer = "test.mosquitto.org"; // Replace with your broker if needed
        const mqttPort = 8081; // WebSocket port for MQTT
        const mqttTopic = "alert-new"; // Topic ESP32 is publishing to

        // Initialize MQTT client
        const client = new Paho.MQTT.Client(mqttServer, mqttPort, "clientId-dashboard-" + Math.random());

        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        client.connect({
            onSuccess: onConnect,
            onFailure: onFailure,
            useSSL: true  // Required for secure MQTT connection on port 8081
        });

        function onConnect() {
            console.log("Connected to MQTT broker");
            document.getElementById("statusMessage").innerHTML = "Connected to MQTT Broker";
            client.subscribe(mqttTopic);
        }

        function onFailure(responseObject) {
            console.log("Failed to connect: " + responseObject.errorMessage);
            document.getElementById("statusMessage").innerHTML = "Failed to connect. Retrying...";
            setTimeout(() => client.connect({ onSuccess: onConnect, onFailure: onFailure, useSSL: true }), 5000); // Retry every 5 seconds
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connection lost: " + responseObject.errorMessage);
                document.getElementById("statusMessage").innerHTML = "Connection lost. Reconnecting...";
                setTimeout(() => client.connect({ onSuccess: onConnect, onFailure: onFailure, useSSL: true }), 5000);
            }
        }

        function onMessageArrived(message) {
            console.log("Message Arrived: " + message.payloadString);

            const payload = JSON.parse(message.payloadString);

            // Update Step Count
            document.getElementById("stepCount").innerText = payload.stepCount;

            // Update Fall Detection Status
            const fallDetectedElement = document.getElementById("fallDetected");
            if (payload.fallDetected === "true") {
                fallDetectedElement.innerText = "Yes";
                fallDetectedElement.classList.remove("no");
            } else {
                fallDetectedElement.innerText = "No";
                fallDetectedElement.classList.add("no");
            }
        }
    </script>

</body>
</html>
